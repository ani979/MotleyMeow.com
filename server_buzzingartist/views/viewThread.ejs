<!doctype html>
<html>
<head lang="en">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	
	<title>Forum</title> 
	<meta name="description" content="Be a part of the buzz." />	    
	<meta name="keywords" content="themes, bootstrap, free, templates, bootstrap 3, freebie,">
	<meta property="og:title" content="MotleyMeow">
	<link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <link href="css/tab.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet"> 

    <style>
	    .links {
			margin-top:20px;
		} 
	</style>
		
</head>

<body>
	<% if(typeof user != 'undefined' && user!=null) { %>
	<div id = "headerloggedin"> </div>
	<% } else { %>
	<div id = "headerloggedout"></div>
	<%}%> 

	<div class="main-container">
	
	    <div class="container">
	    	<div class="row">
	    		<div class="col-md-12">

	    			<div class="links">
    					<h4><a href="/forum">Forum</a> / <a href="/viewCategory?category=<%=category%>"><%=categoryName%></a> / </h4>
    				</div>

	    			<div class="title">
		    			<h3><%= thread.thread.topic %></h3>
		    		</div>

		    		<div class="threadBody">
		    			<p><%= thread.thread.tbody %></p>
		    		</div>

		    		<hr>

		    		<div class="addreply">
		    			<a href="#newReplyModal" role="button" data-toggle="modal" type="button" class="btn btn-lg btn-primary">ADD A REPLY</a>
		    		</div>

		    		<div id="newReplyModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="newReplyLabel" aria-hidden="true">
      
				        <div class="modal-dialog">
				        <div class="modal-content">
				        <div class="modal-header">
				            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				            <h4 class="modal-title">Post a Reply</h4>
				        </div>
				        <div class="modal-body" id="modalbody">
				            <!--<form class="form-horizontal" name="commentform" method="post" action = "/sendMailsToArtists">-->
				            <form class="form-horizontal" name="replyform" id="replyform">
				          
				                <div class="form-group">
				                    <label class="control-label col-md-4" for="body">Reply Body</label>
				                    <div class="col-md-8">
				                        <textarea class="form-control" id="rbody" name="rbody" placeholder="Compose reply" style="min-height:300px;"></textarea>
				                    </div>
				                </div>

				                <div class="form-group">
			                  	 	 <input type="hidden" name="threadid" id="threadid" value="<%= thread._id %>"/>
			                	</div>

								</br>
				                <div class="form-group">
				                    <div class="col-md-6">
				                        <button type="button" value="Submit" class="btn btn-custom pull-right" id="send_btn" onclick="createReply()">Submit Reply</button>
				                    </div>
				                </div>

				            </form>
				        </div><!-- End of Modal body -->
				        </div><!-- End of Modal content -->
				        </div><!-- End of Modal dialog -->

	    			</div><!-- End of Modal --> 
		    		<hr>

		    		<div class="replies">
		    			<h4><small>REPLIES</small></h4>
		    			<% if(thread.thread.replies.length==0) 
    	  					{ %>
    	  						<div>
    	  							<p> Sorry, no replies yet. Use the button above to add a new reply.</p>
    	  						</div>

 		   	  				<% }
 		   	  			else {%>
 		   	  					<% thread.thread.replies.forEach(function(reply) { %>
 		   	  						<div class="reply" id="divallreplies">
 		   	  							<div>
 		   	  								<p><%= reply.comment %></p>
 		   	  							</div>
 		   	  							</br>
 		   	  						</div>	
 		   	  					<% }); %>
 		   	  				<% }
 		   	  			%>
		    		</div>
	    		</div>
	    	</div>
	    </div>
	</div>


	<div id = "footer"></div>
</body>

	<script type="text/javascript" src="js/jquery.noty.packaged.min.js"></script>

<script>
		$("#footer").load("footer.ejs"); 
		$("#headerloggedin").load("/header");
		$("#headerloggedout").load("headerloggedout.ejs");

		function createReply(){
	          console.log("This is executing");

	          var data = {
	            threadid: $("#threadid").val(),
	            rbody: $("#rbody").val()
	          };

	          $.ajax({ 
	           url: "/createReply",
	           type: "POST",
	           cache: false, 
	           async: true,
	           data: data,

	           success: function(data){
	              console.log('Success!');
	              //closeModal();
	              
	              if(data.completed == "OK") {
	               console.log("OK");
	               closeModal();
	               //document.getElementById(divallthreads).innerHTML = "";               
                   location.reload();
                   generateNotificationLayout('success', 'topCenter', 'Reply added');
	 
	                //generateNotificationLayout('success', 'topCenter', 'Post published');
	              } else {
	                console.log("NOK");
	                generateNotificationLayout('error', 'topCenter', 'Some problem with your reply. Check fields again');
	                //generateNotificationLayout('error', 'topCenter', 'Some problem with your post. Check fields again');
	              }
	           }, 

	           error: function(jqXHR, textStatus, err){
	               console.log('text status '+textStatus+', err '+err);
	               //generateNotificationLayout('error', 'topCenter', 'Some problem with your email. Check fields again');
	           }
	        }); //end of ajax function 
	  	} //end of savePostData function

	  	function closeModal()  //function to close modal 
	    {
	       $("#newReplyModal").modal('hide');
	    }

	    function generateNotificationLayout(type, layout, text) {
	       var n = noty({ layout: layout,
	        type: type,
	        text: text, // can be html or string
	        dismissQueue: true, // If you want to use queue feature set this true
	        template: '<div class="noty_message"><span class="noty_text" style="font-size:16px;color:rgb(0, 96, 244);"></span><div class="noty_close"></div></div>',
	        animation: {
	            open: {height: 'toggle'}, // or Animate.css class names like: 'animated bounceInLeft'
	            close: {height: 'toggle'}, // or Animate.css class names like: 'animated bounceOutLeft'
	            easing: 'swing',
	            speed: 500 // opening & closing animation speed
	        },
	        timeout: false, // delay for closing event. Set false for sticky notifications
	        force: false, // adds notification to the beginning of queue when set to true
	        modal: false,
	        maxVisible: 10, // you can set max visible notification for dismissQueue true option,
	        killer: false, // for close all notifications before show
	         // ['click', 'button', 'hover', 'backdrop'] // backdrop click will close all notifications
	        callback: {
	            onShow: function() {
	            },
	            afterShow: function() {},
	            onClose: function() {
	                    
	            },
	            afterClose: function() {},
	            onCloseClick: function() {}
	        },
	        closeWith: ["click","button"],
	        buttons: [
	            {addClass: 'btn btn-primary', text: 'DONE', onClick: function($noty) {
	              $noty.close();
	                }
	             }
	            
	          ]
	      });
	    }   
	</script>

</html>