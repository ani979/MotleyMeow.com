<!DOCTYPE html>
<html>
  <head>
     <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <title>Add New Blog Post</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    
    <link href="blog/bootstrap.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <link href="css/bootstrap-responsive.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/flick/jquery-ui.css">
    <!--Let this be from http-->
    <link href="css/jquery.tagit.css" rel="stylesheet" type="text/css">

    <!-- Formatting toolbar script --> 
    <script src="http://tinymce.cachefly.net/4.1/tinymce.min.js"></script><!--Let this be from http itself-->
    <!--<script src="tinymce/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="tinymce/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>-->
    <script type="application/x-javascript">
      tinymce.init({
        selector:'#postBody',
        plugins: "link"
        //save_onsavecallback: "savePostData"      
      });
    </script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="js/jquery.1.11.2.min.js"></script>
    <script src="js/bootstrap.min.3.3.4.js"></script>
    <link href="css/style.css" rel="stylesheet">       
    
    <!-- Formatting toolbar ends here -->


    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.12/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script> --><!--Probably don't need these-->
  
  </head>

  <body>

    <% if(typeof user != 'undefined' && user!=null) { %>
      <div id = "headerloggedin"> </div>
      <% } else { %>
      <div id = "headerloggedout"></div>
    <%}%> 


    <div class="container">

      <h1>Theatre blog</h1>
      <p>What would you like to share?</p>

<form class="form-horizontal" id="blogForm">
<fieldset>

<!-- Form Name -->
<legend>New Post</legend>

<!-- Text input-->
<div class="control-group">
  <label class="control-label" for="postTitle">Title </label>
  <div class="controls">  
    <input id="postTitle" name="postTitle" type="text" placeholder="Enter a title for your post" style="height:30px;">
  </div>
</div>

<!-- Text input-->
<div class="control-group">
  <label class="control-label" for="postSubtitle">Sub-title </label>
  <div class="controls" >
    <input id="postSubtitle" name="postSubtitle" type="text" placeholder="Enter a 1-2 line description of your post" class="input-xlarge" style="height:30px;">
    
  </div>
</div>


<!-- Textarea -->
<div class="control-group">
  <label class="control-label" for="postBody">Body </label>
  <div class="controls">                     
    <textarea id="postBody" style="width: 350px; height: 300px;" name="postBody" rows="10" cols="100"></textarea>
  </div>
</div>

<!--Hideen field-->
<input type="hidden" id="hiddenbody" name="question_html" />


<!-- Tags -->
  <div class="control-group">
  <label class="control-label" for="postCategories">Add Tags</label>

  <div class="controls" >
    <ul id="tagsForPost" style="margin-left:0px;"></ul>
  </div>

</div>

  <ul id="tagsForPost"></ul> <!--field for tags-->


<!-- Button (Double) -->
<div class="control-group">
  <label class="control-label" for="buttonPublish">Final things</label>
  <div class="controls">
    <button id="buttonPublish" name="buttonPublish" class="btn btn-success" type="submit" value="submit" >Publish Post</button>
    <button id="buttonCancel" name="buttonCancel" class="btn btn-danger" type="button" onclick="cancelPost()">Cancel Post</button>
  </div>
</div>

</fieldset>
</form>


    </div> <!-- /container -->
<div id = "footer"></div>
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery.js"></script>
    <script src="js/jquery.1.11.2.min.js"></script>
    <!-- The JQUERY UI is very much needed for tag and just after jquery UI.js we need to add tag it.js -->
    <script src="js/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/tag-it.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/jquery-validate.js"></script>
<script>
  $(document).ready(function() {
        $("#tagsForPost").tagit();

        $('#blogForm').validate({
          rules: {
            postTitle: {
                required: true
            }
          },
          submitHandler: function(form) {
            alert("here");
            savePostData();
          }  
        });  
    });

  function savePostData(){

          console.log("This is executing");
          /*var ed = tinyMCE.get('content');
          console.log(ed);

          $('#postBody').bind('form-pre-serialize', function(e) {
           tinyMCE.triggerSave();
          });

          var ef = tinyMCE.get('#postBody');
          console.log(ef);*/
         // console.log($("#hiddenbody").val());

         tinyMCE.triggerSave(); //this gives the textarea the value from tinyMCE editor

          /*var checkBoxes = [];
          $.each($("input[name='postCategories']:checked"), function(){
            checkBoxes.push($(this).val());
          });*/

          var data = {
            postTitle: $("#postTitle").val(),
            postSubtitle: $("#postSubtitle").val(),
            postBody: $("#postBody").val(),
            postTags: $("#tagsForPost li").map(function() { if($(this).children('.tagit-hidden-field').val() != "") { return $(this).children('.tagit-hidden-field').val() } }).get()
          };

          //console.log(checkBoxes);
          console.log(data);

          $.ajax({ 
           url: "/saveNewBlogPostData",
           type: "POST",
           cache: false, 
           async: true,
           data: data,

           success: function(data){
              console.log('Success!');
              
              if(data.completed == "OK") {
                console.log("OK");
                window.location.href = data.redirect;
                
              } else {
                console.log("NOK");
                //generateNotificationLayout('error', 'topCenter', 'Some problem with your post. Check fields again');
              }
           }, 

           error: function(jqXHR, textStatus, err){
               console.log('text status '+textStatus+', err '+err);
               //generateNotificationLayout('error', 'topCenter', 'Some problem with your email. Check fields again');
           }
        }); //end of ajax function 
  } //end of savePostData function

  function cancelPost(){
    //console.log("I decided to cancel");
    window.location = "/myBlogPosts";
  }

</script>

</body>
  
  <script>
    $("#footer").load("footer.ejs"); 
    $("#headerloggedin").load("/header");
    $("#headerloggedout").load("headerloggedout.ejs");
  </script>

</html>